# Shirt Tracker -- Continuation Prompt

> **Last updated:** February 17, 2026
> **Current version:** 2.0.1
> **Latest commit:** `dc21fea` -- Restore hidden column preferences from cloud sync payload
> **Repo:** `https://github.com/aaronmdunn/shirt-tracker` (branch: `main`)
> **Repo root:** `/Users/ad21/Documents/shirt-tracker/`


## Who I Am

I'm not a developer. I don't know how build tools, module systems, or bundlers work. Please ELI5 every step, explain what you're about to do before you do it, and hold my hand through the process. If there's a decision to make, explain the options in plain English and ask me. Don't assume I know what any technical term means. Do NOT commit unless I explicitly ask.


## Project Overview

**Shirt Tracker** is a fan-made clothing inventory app with three platforms: desktop web, mobile web, and Tauri desktop. Users create tabs (one per brand), add rows for each shirt they own, and track condition, size, type, fandom, price, photos, notes, and tags. Data syncs to Supabase for cross-device access and supports public share links for read-only viewing.


## Tech Stack

- HTML/CSS/Vanilla JS (no framework, no bundler, no transpiler)
- Tauri v2 (desktop app, uses WKWebView on macOS)
- Supabase (auth, storage bucket `shirt-photos`, cloud sync via `shirt_state` table)
- Netlify (web deploy with `_redirects` for `/d` and `/m` routing)
- No external JS dependencies. No npm runtime dependencies. Only dev dependency is `@tauri-apps/cli`.


## Full Project Structure

```
shirt-tracker/
+-- .gitignore
+-- CONTINUATION-PROMPT.md              (this file)
+-- package.json                        (scripts defined here)
+-- netlify.toml
+-- apps/
|   +-- web-desktop/src/                <-- DESKTOP SOURCE (you edit these)
|   |   +-- index.html                  (852 lines -- HTML only + 4 small inline head scripts)
|   |   +-- style.css                   (2,280 lines -- all CSS)
|   |   +-- app.js                      (6,004 lines -- all JavaScript)
|   |   +-- assets/
|   |   |   +-- icons/                  (13 PNG icons: shirt, flannel, polo, socks, hoodie, comfort, boxers, hat, jacket, pant, shorts, backpack, hawaiian-shirt)
|   |   +-- fonts/
|   |   +-- manifest.webmanifest
|   |   +-- steve.png
|   +-- web-mobile/src/                 <-- MOBILE SOURCE (you edit these)
|   |   +-- index.html                  (871 lines)
|   |   +-- style.css                   (2,449 lines)
|   |   +-- app.js                      (5,956 lines)
|   |   +-- assets/, fonts/, manifest.webmanifest, steve.png
|   +-- web-root/                       <-- BUILD OUTPUT for Netlify
|   |   +-- _redirects
|   |   +-- d/index.html                (single-file, auto-generated)
|   |   +-- m/index.html                (single-file, auto-generated)
|   +-- desktop-tauri/
|       +-- src/index.html              (single-file, auto-generated by sync)
|       +-- src/assets/, fonts/, etc.   (synced from desktop source)
|       +-- src/main.js                 (legacy Tauri boilerplate, unused)
|       +-- src/styles.css              (legacy Tauri boilerplate, unused)
|       +-- src-tauri/
|           +-- tauri.conf.json         (version: "2.0.1")
+-- scripts/
|   +-- build-web-root.mjs             (copies source -> web-root, inlines CSS/JS)
|   +-- sync-tauri-html.mjs            (inlines CSS/JS, syncs to Tauri)
|   +-- bump-version.mjs               (updated in this session -- see below)
|   +-- stamp-deploy-date.mjs
|   +-- build-tauri.sh
+-- supabase/
+-- netlify/
+-- release-notes/
    +-- 1.936.0.md
    +-- 1.939.002.md
    +-- 1.939.2.md
    +-- 1.939.3.md
```


## How the Build Works

The source is split into three files per platform for easy editing (HTML, CSS, JS). The **deployed/built outputs must remain single-file HTML**. Build scripts read the three source files and stitch them back into one.

### Build Commands

| Command | What it does |
|---------|-------------|
| `npm run build:web-root` | Copies desktop source to `web-root/d/`, mobile to `web-root/m/`, inlines CSS/JS into single-file HTML, deletes separate files, injects git commit date |
| `npm run sync:tauri` | Reads desktop source, inlines CSS/JS, injects build timestamp, writes single-file HTML to `desktop-tauri/src/index.html`, syncs assets/fonts/manifest/steve.png |
| `npm run build:web-root:stage` | Build + `git add .` + `git status -sb` |
| `npm run prep:web-deploy` | Same as `build:web-root:stage` |
| `npm run pretauri` | Runs `sync:tauri` automatically before Tauri builds (was previously bump-version, changed in this session) |

### Build Script Details

`scripts/build-web-root.mjs` calls `inlineSources()` which:
1. Reads `style.css`, wraps in `<style>...</style>`, replaces `<link rel="stylesheet" href="style.css">`
2. Reads `app.js`, wraps in `<script>...</script>`, replaces `<script src="app.js"></script>`
3. Deletes separate CSS/JS files from output
4. Injects last git commit date into `LAST_COMMIT_DATE`

`scripts/sync-tauri-html.mjs` does the same inlining for Tauri and also syncs assets, fonts, manifest, and steve.png.


## Version Management

### bump-version.mjs (Rewritten in This Session)

The version bump script was rewritten from scratch. It now:
- Accepts an explicit version argument: `node scripts/bump-version.mjs 2.0.2`
- Targets the correct 5 source files (not build outputs)
- Uses regexes that match the current format (no "beta")
- Verifies all 7 locations after updating
- Exits with error if no version provided or invalid format

### The 7 Version Locations

| # | File | What |
|---|------|------|
| 1 | `apps/desktop-tauri/src-tauri/tauri.conf.json` line 4 | `"version": "2.0.1"` |
| 2 | `apps/web-desktop/src/app.js` line 31 | `const APP_VERSION = "2.0.1"` |
| 3 | `apps/web-mobile/src/app.js` line 31 | `const APP_VERSION = "2.0.1"` |
| 4 | `apps/web-desktop/src/index.html` line 401 | About dialog: `Shirt Tracker v2.0.1` |
| 5 | `apps/web-mobile/src/index.html` ~line 426 | About dialog: `Shirt Tracker v2.0.1` |
| 6 | `apps/web-desktop/src/app.js` ~line 2240 | Backup metadata: `version: "2.0.1"` |
| 7 | `apps/web-mobile/src/app.js` ~line 2312 | Backup metadata: `version: "2.0.1"` |

There's also a dynamic JS function that sets the about dialog text at runtime:
- Desktop `app.js` ~line 1981: `` aboutVersion.textContent = `Shirt Tracker v${APP_VERSION}` ``
- Mobile `app.js` ~line 2053: same

The `tauri.conf.json` window title is also set by the bump script: `"title": "Shirt Tracker v2.0.1"`.

### Version Bump Workflow

When the user says "bump to X.X.X":
1. Run `node scripts/bump-version.mjs X.X.X`
2. Run `npm run build:web-root`
3. Run `npm run sync:tauri`


## Key Architecture Details

### State Management
- `state.rows` -- Array of row objects, each with `{ id, cells: { columnId: value } }`
- `state.columns` -- Array of column definitions with `{ id, label/name, type, options }`
- `tabsState` -- `{ tabs: [...], activeTabId }` for multi-tab support
- `columnOverrides` -- `{ fandomOptionsByTab: {}, typeOptionsByTab: {}, hiddenColumnsByTab: {} }` for per-tab dropdown options and per-tab column visibility
- `globalColumns` -- Shared column schema across all tabs (Fandom/Type options stripped out)
- All state persisted to localStorage and synced to Supabase

### Tab System
- Each tab has its own completely independent state stored under a separate localStorage key: `"shirts-db-v3:{tabId}"`
- Rows are NOT filtered by tab -- different tabs = different localStorage entries = different datasets
- `globalColumns` enforces all tabs share the same column structure (columns/order)
- `columnOverrides` stores per-tab differences: Fandom options, Type options, hidden columns

### Per-Tab Column Hiding (Added in This Session)
- `columnOverrides.hiddenColumnsByTab` -- Map of `{ tabId: [columnId, ...] }` storing which columns are hidden on each tab
- `getHiddenColumnIds()` -- Returns a Set of hidden column IDs for the current tab
- `getVisibleColumns()` -- Returns `state.columns` filtered to exclude hidden columns
- `renderHeader()` and `renderRows()` use `getVisibleColumns()` so hidden columns don't appear in the table
- `renderColumns()` (Edit Columns panel) shows ALL columns with Hide/Show button -- hidden ones appear dimmed (opacity 0.55)
- `renderFilterOptions()` fallback uses `getVisibleColumns()` so hidden columns don't appear in filter dropdown
- Data for hidden columns is NEVER deleted -- just not displayed. CSV export includes all columns.
- Hidden column preferences sync to Supabase via `columnOverrides` in `buildCloudPayload()` and are restored in `applyCloudPayload()`
- Persisted to localStorage under `COLUMNS_KEY` ("shirts-columns-v2") alongside `globalColumns` and other overrides

### Column Reordering (Updated in This Session)
- Columns are reordered via drag-and-drop handles in the Edit Columns panel
- Each column row has a `≡` grip handle on the left -- press/touch and drag to reorder
- Works with both mouse events (desktop) and touch events (mobile)
- On drop, if order changed, `state.columns` is reordered, `setGlobalColumns()` is called, state is saved, and table re-renders
- Previously used up/down arrow buttons, which were removed

### Key localStorage Keys
| Key | Purpose |
|-----|---------|
| `shirts-db-v3:{tabId}` | Per-tab state (columns, rows, widths, sort, filter, readOnly) |
| `shirts-tabs-v1` | Tab list and active tab ID |
| `shirts-columns-v2` | `globalColumns` + `columnOverrides` (fandom/type options by tab + hidden columns by tab) |
| `shirts-event-log-v1` | Event log (max 200 entries, with snapshot data on destructive actions) |
| `shirts-type-icon-map` | Custom type->icon mappings (includes data URLs for uploaded custom icons) |
| `shirts-public-share-visibility-v1` | Public share column visibility settings |
| `shirts-profile-name-prompted` | Whether the display name prompt has been shown |
| `tab-logos-map` | Tab logo images |
| `shirt-update-date` | Last update timestamp |

### Cloud Sync System
- `buildCloudPayload()` -- Assembles full state for upload: all tabs' state, tabsState, tabLogos, eventLog, typeIconMap, columnOverrides (including hiddenColumnsByTab), globalColumns, publicShareVisibility, version
- `syncToSupabase()` -- Debounced (1.2s), upserts payload into `shirt_state` table keyed by `user_id`
- `loadRemoteState()` -- Downloads from `shirt_state`, calls `applyCloudPayload()` to hydrate app
- `applyCloudPayload()` -- Restores all data from cloud, writes each tab's state to localStorage, restores columnOverrides (all three fields), globalColumns
- `scheduleSync()` -- Called after most state changes (saveState, event log, tags, icon map changes)

### Icon System
- `TYPE_ICON_DEFAULTS` -- Static object mapping ~27 lowercase type names to `assets/icons/*.png` paths
- `ICON_CHOICES` -- 12 built-in icons shown in the picker: Shirt, Flannel, Polo, Socks, Performance Hoodie, Comfort Hoodie, Boxers, Hat, Jacket, Pants, Shorts, Misc
- `loadTypeIconMap()` / `saveTypeIconMap()` -- Read/write custom mappings from localStorage
- `getTypeIconSrc(typeValue)` -- Resolution: custom map -> defaults -> empty string
- Icon picker is a visual 4-column grid of clickable tiles (replaced dropdown in this session)
- Custom uploaded icons stored as base64 data URLs (max 200KB), synced to cloud
- `hawaiian-shirt.png` exists in assets but is only used for the app title bar, not in ICON_CHOICES

### Icon Picker (Updated in This Session)
- Dialog `#type-icon-dialog` contains a `<div id="type-icon-grid">` (replaced old `<select>`)
- Grid is built dynamically in JS with 4 columns of tiles showing actual icon images + labels
- Last tile is a "+" upload option for custom icons
- Clicking a tile highlights it with blue border, sets `selectedIconValue`
- Save handler reads from `selectedIconValue` instead of the old `<select>.value`
- The hidden `<select id="type-icon-select">` is kept in HTML but unused (avoids errors from old getElementById reference)

### Add New Dropdown System
- All select-type dropdowns get an "Add new..." option (`__add_new__` sentinel value) when not in read-only mode
- Selecting "Add new..." opens `showTextPrompt()` custom dialog (replaced `window.prompt()` which is blocked in WKWebView)
- `handleCellEvent` bails early if `target.value === "__add_new__"` to avoid writing sentinel to state
- `flushInputsToState` also skips selects with value `__add_new__`

### Event System
- `handleCellEvent` -- Delegated listener on `sheetBody` for `input` and `change` events
- `createCellInput` -- Factory function creating appropriate input for each cell type
- `flushInputsToState()` -- Reads all current DOM input values back into `state.rows`. Called at top of `renderRows()`. Safe with hidden columns -- only touches cells that have DOM inputs present.

### Photo Dialog (Fixed in This Session)
- Dialog uses `display: flex; flex-direction: column` with `min-height: 60vh; max-height: 90vh`
- `.dialog-body` uses `flex: 1 1 0; align-items: stretch; overflow: hidden; min-height: 0; padding: 12px`
- Image uses `max-width: 100%; max-height: 100%; object-fit: contain; margin: auto`
- The `margin: auto` centers the image without pushing it outside container bounds (unlike the old `align-items: center` which caused top clipping)
- Previous attempts with `align-items: center` + `overflow: hidden` caused symmetrical clipping on tall images
- `calc()` based max-height doesn't work in WKWebView inside flex dialogs -- use percentage-based constraints instead

### CSV Export/Import
- Export: RFC-compliant CSV with all columns including Price and Tags, excludes photo/preview columns. Exports ALL columns (not just visible ones).
- Import: Parses CSV, matches headers case-insensitively, appends rows, auto-adds new select option values, imports tags

### Filter System
- Filter dropdown lists: "All Columns", then each visible column in left-to-right table order, then "Tags" at the end
- Tags was moved to the end of the dropdown in this session (was previously second, right after All Columns)
- `renderFilterOptions()` reads column order from rendered `<th>` elements, with fallback to `getVisibleColumns()`

### Public Share Link System
- Share links use format `https://shirt-tracker.com/?share=TOKEN` or `https://shirt-tracker.com/d/?share=TOKEN`
- `publicShareVisibility` controls which columns viewers see: `{ mode: "auto"|"all"|"custom", columnIds: [] }`
- `applyViewerRedactions()` actually removes columns from `state.columns` for viewers

### Featured Brands (Credits & Acknowledgements)
Currently 8 brands listed in both the credits dialog and legal disclaimer:
1. RSVLTS (https://www.rsvlts.com/)
2. 7-Strong (https://7-strong.com/)
3. Reyn Spooner (https://www.reynspooner.com/)
4. Project Good Apparel (https://www.projectgoodapparel.co/)
5. Dixxon (https://www.dixxon.com/)
6. Park Candy (https://www.parkcandy.com/)
7. Retro Rifle (https://retro-rifle.com/)
8. Hales Speed Shop (https://www.halesspeedshop.com/)

### Help System
- Floating `?` button (36px circle, fixed bottom-right, z-index 9999) created via JS with inline styles
- Opens a comprehensive help dialog with 7 sections
- Hidden when signed out and for share link viewers
- Button is appended to `<body>` to avoid the auth-row CSS visibility trap

### Welcome Message (New Users)
- Shown when `state.columns.length > 0` and `state.rows.length === 1` and all cells are empty
- Clears immediately when user enters data

### Responsive Card Layout (max-width: 980px)
- Uses `body[data-active-tab]` to apply white backgrounds to all tabs


## Discoveries (Bugs/Quirks Found)

- **WebKit dialog sizing quirk:** `<dialog>` elements with `display: flex` + `flex-direction: column` don't auto-size height properly in WKWebView (Tauri on macOS + mobile Safari). Fixed with `min-height: 60vh` on `.photo-dialog`.
- **WKWebView blocks window.prompt():** Silently returns null. Replaced with custom `<dialog>` + `showTextPrompt()`.
- **WKWebView vh calc in flex dialogs:** `max-height: calc(90vh - 140px)` on images inside flex dialogs doesn't resolve correctly. Use `max-height: 100%` with `min-height: 0` on the flex container instead.
- **Flex centering + overflow: hidden causes clipping:** `align-items: center` positions children by center point. If content exceeds container, it clips equally top and bottom. Fix: use `align-items: stretch` with `margin: auto` on the child.
- **display:flex on td elements:** Causes the browser to generate anonymous empty table cells. Use an inner wrapper `<div>` for flex layout instead.
- **Auth-row CSS trap (IMPORTANT):** `body[data-auth="signed-out"] .auth-row > :not(#auth-action):not(.signedout-greeting) { display: none !important }` hides ALL children of `.auth-row` except Sign In and the greeting when signed out. Do NOT place new buttons inside `.auth-row`.
- **Dropdown reset bug (FIXED):** Two root causes: (1) `handleCellEvent` wrote `"__add_new__"` sentinel to `state.rows`, (2) `renderRows()` destroyed DOM without flushing inputs first. Fixed with guard in `handleCellEvent` + `flushInputsToState()` call at top of `renderRows()`.
- **Mobile column manager overflow:** The Edit Columns grid on mobile overflows with too many buttons. The options summary column is hidden on mobile (`display: none` on `.column-row > .column-type`), and button padding/font are reduced.
- **Touch drag on mobile:** `touchmove` listeners must use `{ passive: false }` and call `e.preventDefault()` to prevent page scrolling during drag-and-drop.


## Recent Commit History (Newest First)

```
dc21fea Restore hidden column preferences from cloud sync payload
7ae4ad2 Update .gitignore
75b11e3 Add Hales Speed Shop to featured brands and update legal disclaimer
00783c1 Replace column reorder arrows with drag-and-drop handles
35542a4 Hide column options summary in mobile Edit Columns panel to fix layout overflow
7e430e2 Fix mobile Edit Columns panel overflowing off screen
6cc2bbb Fix photo dialog image clipping by replacing flex centering with margin auto
f70ad39 Add per-tab column hiding and move Tags to end of filter dropdown
113ccfd Rewrite bump-version script and replace icon picker dropdown with visual grid
65bc760 Split source HTML into separate CSS/JS files, bump to v2.0.1
f2e8890 Fix gray row background on non-whitelisted tabs in responsive layout
3f6e632 Fix photo dialog image clipping in Tauri WKWebView
2f7a46a Remove one-click sync app instructions from README
6874dd4 Bump version to 1.939.3 with release notes and scroll hint arrow
7783819 Add Import CSV menu item, fix ghost cell bug, and add Retro Rifle to credits
bbbf4c2 Replace window.prompt() with custom dialog and change preview background to white
968ce3b Update 1.939.2 release notes with help system, welcome message, and UI polish
```


## What Was Done in the Feb 16-17, 2026 Session

### 1. Rewrote bump-version.mjs
- Old script targeted wrong files (index.html instead of app.js), appended "beta", only supported minor bumps
- New script: explicit version argument, correct 5 source files, no beta, verifies all 7 locations
- Changed `pretauri` npm script from `bump-version.mjs` to `sync-tauri-html.mjs`

### 2. Icon Picker Visual Grid
- Replaced plain text `<select>` dropdown with a 4-column grid of clickable icon tiles
- Each tile shows actual icon image (36x36) with label underneath
- "Upload custom..." is a "+" tile at the end
- Updated labels: "Hoodie" -> "Performance Hoodie", "Backpack" -> "Misc"

### 3. Per-Tab Column Hiding
- Added `hiddenColumnsByTab` to `columnOverrides`
- `getVisibleColumns()` helper filters hidden columns for current tab
- `renderHeader` and `renderRows` use visible columns only
- Hide/Show button in Edit Columns panel per column
- Hidden columns dimmed at opacity 0.55
- Data never deleted, CSV export includes all columns
- Syncs to Supabase (upload was automatic, added missing restore line in `applyCloudPayload`)

### 4. Filter Dropdown Order
- Moved "Tags" from second position to last in filter column dropdown
- Dropdown now reads: All Columns, [columns in table order], Tags

### 5. Photo Dialog Fix
- Fixed image clipping by replacing `align-items: center` with `align-items: stretch` + `margin: auto`
- Changed `flex: 1` to `flex: 1 1 0`, overrode padding to 12px
- Images now fit entirely within dialog, no scrolling, no clipping

### 6. Drag-and-Drop Column Reordering
- Removed up/down arrow buttons from Edit Columns
- Added `≡` grip handle with drag-and-drop using mouse + touch events
- Dragged row gets shadow + reduced opacity
- On drop, new order saved to state and globalColumns

### 7. Mobile Edit Columns Layout Fixes
- Reduced grid column minimums for mobile
- Hid options summary column on mobile
- Reduced button padding and font size

### 8. Credits Updates
- Added Hales Speed Shop to Featured Brands
- Added Retro Rifle and Hales Speed Shop to legal disclaimer brand list


## Rules for Working With Me

1. **Workflow/approval required before any code change:** ELI5 plan -> Risk score (1-10) -> Rollback instruction -> Ask permission -> Wait for "Yes"
2. **No CSS unless explicitly authorized.** Use JS inline styles if needed.
3. **Always run `npm run build:web-root`** after any source edits.
4. **If desktop HTML changes, also run `npm run sync:tauri`.**
5. **No commits unless explicitly asked.** No destructive git commands.
6. **Never revert unrelated changes.**
7. **Avoid XSS; no unsanitized `innerHTML`.**
8. **For commit messages:** Provide Title + detailed Summary with no bullet points.
9. **Release notes always go in `/release-notes/` directory**, named by version (e.g. `2.0.2.md`). Use grouped-by-feature-area format. Historical release notes are never modified.
10. Changes should always be applied to **both desktop web and mobile web** sources unless specified otherwise.
11. No new dependencies or build tools (no webpack, vite, rollup, etc.)
12. Build scripts are plain Node.js `.mjs` files -- keep them that way.
13. Build outputs must always be single-file HTML.
14. The user is not a developer. ELI5 everything. Ask before acting. Hold their hand.


## Suggested Next Steps / Known Issues

### Release Notes for 2.0.2
A new release notes file (`release-notes/2.0.2.md`) should be written when the user is ready to version bump. It should cover all the changes from this session: icon grid picker, per-tab column hiding, drag-and-drop column reorder, photo dialog fix, filter dropdown order, bump-version rewrite, mobile layout fixes, credits updates.

### Version Bump to 2.0.2
When ready, run `node scripts/bump-version.mjs 2.0.2` followed by builds. The current version is still 2.0.1.

### Potential Future Features
- **Tab reordering** -- tabs are currently in creation order; drag-and-drop reordering like columns would be nice
- **Undo/redo** -- no undo system exists currently
- **Bulk operations** -- select multiple rows and apply actions (delete, move to tab, tag)
- **Column width persistence per tab** -- column widths are shared, could be per-tab
- **Offline indicator** -- no visual feedback when offline
- **Conflict resolution** -- if two devices edit at the same time, last write wins with no merge


## Important File Locations Quick Reference

| What | Path |
|------|------|
| Desktop HTML source | `apps/web-desktop/src/index.html` |
| Desktop CSS source | `apps/web-desktop/src/style.css` |
| Desktop JS source | `apps/web-desktop/src/app.js` |
| Mobile HTML source | `apps/web-mobile/src/index.html` |
| Mobile CSS source | `apps/web-mobile/src/style.css` |
| Mobile JS source | `apps/web-mobile/src/app.js` |
| Tauri config | `apps/desktop-tauri/src-tauri/tauri.conf.json` |
| Web build script | `scripts/build-web-root.mjs` |
| Tauri sync script | `scripts/sync-tauri-html.mjs` |
| Version bump script | `scripts/bump-version.mjs` |
| Icon assets | `apps/web-desktop/src/assets/icons/` |
| Netlify redirects | `apps/web-root/_redirects` |
| Release notes | `release-notes/` |
